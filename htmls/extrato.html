<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <title>Extrato Bancário</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-image: url('../icons/logo.png');
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
            background-size: contain;
            background-color: #f8f9fa;
        }
        .valor-alto {
            color: #ff6b6b;
            font-weight: bold;
        }
        .entrada {
            color: #40c057;
        }
        .saida {
            color: #ff6b6b;
        }
        .saldo-atual {
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }
        .transaction-code {
            font-size: 12px;
            color: #666;
        }
        .card {
            background-color: #ffffff90;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Extrato Bancário</h1>
            <a href="adicionar_transacao.html" class="btn btn-primary">
                + Nova Transação
            </a>
        </div>
        
        <!-- Saldo -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Saldo Atual</h5>
                <p class="saldo-atual" id="saldoAtual">R$ 0,00</p>
            </div>
        </div>

        <!-- Lista de Transações -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Histórico de Transações</h5>
                <div class="card mb-3 border-primary">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-12 col-md-auto mb-2 mb-md-0">
                                <label for="filtroData" class="form-label fw-bold mb-0">Data do Extrato:</label>
                            </div>
                            <div class="col-12 col-md-auto mb-2 mb-md-0">
                                <input type="date" class="form-control form-control-lg" id="filtroData">
                            </div>
                            <div class="col-12 col-md-auto">
                                <button class="btn btn-primary btn-lg me-2" onclick="filtrarTransacoes(document.getElementById('filtroData').value)">
                                    <i class="fas fa-search"></i> Filtrar
                                </button>
                                <button class="btn btn-outline-secondary btn-lg" onclick="limparFiltro()">
                                    <i class="fas fa-times"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Código</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody id="transacoesLista">
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Função para gerar código único da transação
        function gerarCodigoTransacao() {
            return 'TRX-' + Date.now().toString(36).toUpperCase() + 
                   Math.random().toString(36).substr(2, 5).toUpperCase();
        }

        // Função para formatar valor em reais
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        // Função para formatar data
        function formatarData(data) {
            return new Date(data).toLocaleString('pt-BR');
        }

        // Carregar dados do usuário e saldo
        async function carregarDados() {
            const userLogado = JSON.parse(localStorage.getItem('userLogado'));
            if (!userLogado) {
                window.location.href = 'signin.html';
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/saldo/${userLogado.id}`);
                if (!response.ok) {
                    console.error('Falha ao obter saldo:', response.status);
                    document.getElementById('saldoAtual').textContent = formatarMoeda(0);
                    return;
                }
                const data = await response.json();
                const saldoNum = Number(data.saldo);
                document.getElementById('saldoAtual').textContent = formatarMoeda(Number.isFinite(saldoNum) ? saldoNum : 0);
                await carregarTransacoes();
            } catch (erro) {
                console.error('Erro ao carregar saldo:', erro);
                alert('Erro ao carregar dados da conta');
            }
        }

        let todasTransacoes = []; // Armazena todas as transações
        
        // Carregar histórico de transações
        async function carregarTransacoes(filtroData = '') {
            const userLogado = JSON.parse(localStorage.getItem('userLogado'));
            try {
                const response = await fetch(`http://localhost:3000/api/extrato/${userLogado.id}`);
                const transacoes = await response.json();
                todasTransacoes = transacoes; // Guarda todas as transações
                
                let transacoesFiltradas = transacoes;
                if (filtroData) {
                    // Converte o filtro para o início do dia em UTC
                    const dataFiltro = new Date(filtroData);
                    dataFiltro.setHours(0, 0, 0, 0);
                    
                    // Filtra transações do dia selecionado
                    transacoesFiltradas = transacoes.filter(transacao => {
                        const dataTransacao = new Date(transacao.data);
                        return dataTransacao.toISOString().split('T')[0] === dataFiltro.toISOString().split('T')[0];
                    });
                }
                
                const lista = document.getElementById('transacoesLista');
                lista.innerHTML = '';

                transacoesFiltradas.forEach(transacao => {
                    const row = document.createElement('tr');
                    const valorClass = transacao.valor >= 5000 ? 'valor-alto' : '';
                    const tipoClass = transacao.tipo === 'entrada' ? 'entrada' : 'saida';
                    // Sempre exibe 5 letras aleatórias para o código
                    const letras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    let codigo = '';
                    for (let i = 0; i < 5; i++) {
                        codigo += letras.charAt(Math.floor(Math.random() * letras.length));
                    }
                    row.innerHTML = `
                        <td>${formatarData(transacao.data)}</td>
                        <td>${transacao.descricao}</td>
                        <td class="transaction-code" style="font-size:1.2em;color:#0d6efd;font-weight:bold;">${codigo}</td>
                        <td class="${tipoClass}">${transacao.tipo}</td>
                        <td class="${valorClass} ${tipoClass}">${formatarMoeda(transacao.valor)}</td>
                    `;
                    lista.appendChild(row);
                });
            } catch (erro) {
                console.error('Erro ao carregar transações:', erro);
                alert('Erro ao carregar histórico de transações');
            }
        }

        // Recarregar dados a cada 30 segundos
        setInterval(carregarDados, 30000);

        // Inicializar página
        window.addEventListener('load', carregarDados);

        // Função para filtrar transações por data
        function filtrarTransacoes(data) {
            carregarTransacoes(data);
        }

        // Função para limpar filtro
        function limparFiltro() {
            document.getElementById('filtroData').value = '';
            carregarTransacoes();
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').catch(e => console.warn('SW registration failed', e));
        }
    </script>
</body>
</html>